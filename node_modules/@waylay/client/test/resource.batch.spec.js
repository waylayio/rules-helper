/* eslint-env jest */

const moxios = require('moxios')
const Url = require('url')

const Waylay = require('../index')
const BatchResource = require('../lib/resource.batch')

const client = new Waylay({
  token: 'a-test-token',
  domain: 'my-domain.waylay.io'
})

beforeEach(() => moxios.install(client.httpClient))
afterEach(() => moxios.uninstall())

test('batch', done => {
  const resource = new BatchResource({ client })

  const entity = 'some-waylay-entity'
  const action = 'just-do-it'
  const query = {
    ids: ['blinding', 'lights']
  }

  resource._batch(entity, action, query)

  moxios.wait(() => {
    const { config, url } = moxios.requests.mostRecent()

    expect(config).toMatchObject({
      method: 'post',
      data: JSON.stringify({
        entity,
        action,
        query
      })
    })
    expect(Url.parse(url)).toMatchObject({
      protocol: 'https:',
      host: 'my-domain.waylay.io',
      path: '/api/batch'
    })

    done()
  })
})

test('batch with actionParameters', done => {
  const resource = new BatchResource({ client })

  const entity = 'some-waylay-entity'
  const action = 'just-do-it'
  const query = {
    ids: ['blinding', 'lights']
  }
  const actionParameters = {
    foo: 'bar'
  }

  resource._batch(entity, action, query, actionParameters)

  moxios.wait(() => {
    const { config, url } = moxios.requests.mostRecent()

    expect(config).toMatchObject({
      method: 'post',
      data: JSON.stringify({
        entity,
        action,
        query,
        actionParameters
      })
    })
    expect(Url.parse(url)).toMatchObject({
      protocol: 'https:',
      host: 'my-domain.waylay.io',
      path: '/api/batch'
    })

    done()
  })
})

test('operation', done => {
  const resource = new BatchResource({ client })

  const operationId = 'desert-storm'

  resource.operation(operationId)

  moxios.wait(() => {
    const { config, url } = moxios.requests.mostRecent()

    expect(config).toMatchObject({ method: 'get' })
    expect(Url.parse(url)).toMatchObject({
      protocol: 'https:',
      host: 'my-domain.waylay.io',
      path: `/api/batch/${operationId}`
    })

    done()
  })
})
